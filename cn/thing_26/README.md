# 不要忽略那个错误！

> *有一天晚上，我正走在街上去酒吧见几个朋友。我们已经有一段时间没有一起喝酒了，我很期待再次见到他们。由于匆忙，我没有留心走路。我绊倒在路边的台阶边，摔倒在地。唉，我不留心也是活该吧，我想。*

> *我摔伤了腿，但我急着去见朋友，所以我自己爬起来继续走。随着我走得越远，疼痛感越来越严重。虽然一开始我把它归咎于震惊，但很快我意识到有些不对劲。*

> *但我还是匆匆赶往酒吧。当我到达那里时，我已经痛苦不堪了。我度过了一个不太愉快的夜晚，因为我非常分心。第二天早上，我去看医生，发现我胫骨骨折了。如果当我感到疼痛时停下来，我就可以避免造成更多的伤害。可能是我一生中最糟糕的早晨。*

太多的程序员像我那个灾难般的夜晚一样编写代码。

*错误？什么错误？不会很严重的。老实说，我可以忽略它。* 这对于稳定的代码来说并不是一个成功的策略。事实上，这只是纯粹的懒惰。（错误的类型。）无论你认为你的代码中的错误有多么不可能发生，你都应该始终检查并处理它。每一次都要如此。如果你不这样做，你并没有节省时间：你只是为未来可能出现的问题埋下隐患。

我们可以通过多种方式报告代码中的错误，包括：

- **返回代码**可以用作函数的结果值，表示“它没有成功”。很容易忽略错误的返回代码。在代码中你看不到任何突出显示问题的内容。实际上，忽略一些标准C函数的返回值已经成为一种惯例。你有多经常检查printf的返回值？

- **errno**是一个奇怪的C特例，它是一个单独的全局变量，用于表示错误。它很容易被忽略，难以使用，并导致各种各样的问题 - 例如，当你有多个线程调用同一个函数时会发生什么？有些平台会让你免受此类痛苦的困扰，而其他平台则不会。

- **异常**是一种更结构化、由语言支持的处理错误的方式。而且你不可能忽视它们。或者你真的能忽视它们吗？我见过很多这样的代码：

```
try {
    // ...do something...
}
catch (...) {} // ignore errors
```

这种可怕的结构的救命稻草在于它突出了你正在做一些道德上可疑的事情。

如果你忽视错误，视而不见，假装一切都没有出错，你就会承担很大的风险。就像我的腿最后变得比我立刻停止行走时更糟糕一样，不顾一切地继续前进会导致非常复杂的故障。尽早处理问题。及时解决。

不处理错误会导致以下问题：

- **脆弱的代码**。代码中充满了令人兴奋的、难以找到的错误。

- **不安全的代码**。黑客经常利用错误处理不当来攻破软件系统。

- **结构不良**。如果你的代码中有很多繁琐的错误处理，你可能有一个糟糕的接口。将其表达出来，使错误变得不那么突出，处理起来也不那么繁琐。

就像你应该检查代码中的所有潜在错误一样，你需要在接口中暴露所有可能出错的情况。不要隐藏它们，假装你的服务总是正常工作。

为什么我们不检查错误？有很多常见的借口。你同意其中哪些？你会如何反驳每个借口？

- 错误处理会使代码的流程变得杂乱，使其更难阅读，更难发现“正常”的执行流程。

- 这是额外的工作，而且我有一个临近的截止日期。

- 我知道这个函数调用*永远不会*返回错误（printf总是有效的，malloc总是返回新的内存 - 如果它失败了，我们会有更大的问题...）。

- 这只是一个玩具程序，不需要达到生产级别的水平。

由[Pete Goodliffe](http://programmer.97things.oreilly.com/wiki/index.php/Pete_Goodliffe)撰写
