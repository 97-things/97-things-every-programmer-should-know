# 使用理性进行编码

通过手工推理软件的正确性往往导致形式化证明的长度超过代码本身，并且比代码更容易包含错误。自动化工具是可取的，但并非总是可行的。下面介绍一种中间路径：半形式地推理正确性。

这种方法的基本思路是将考虑的所有代码划分为短的部分——从一行代码，如函数调用，到不超过十行的代码块，并对它们的正确性进行论证。这些论证只需要足够强大，能够说服你的“魔鬼的拥护者”同事程序员。

应该选择一个部分，以便在每个端点处，*程序的状态*（即程序计数器和所有“存活”对象的值）满足一个容易描述的属性，并且该部分的功能（状态转换）易于描述为一个单一的任务——这将使推理更简单。这种端点属性概括了函数的*前置条件*和*后置条件*以及循环和类（与它们的实例相关）的*不变量*的概念。力求使部分尽可能相互独立简化了推理，并且在修改这些部分时是不可或缺的。

许多被广为人知（尽管可能不太遵循）并被认为是“好”的编码实践可以使推理更容易。因此，只要打算推理代码，你就已经开始思考更好的风格和结构。毫不奇怪，大多数这些实践都可以通过静态代码分析器进行检查：

- 避免使用goto语句，因为它们使远程部分高度相互依赖。

- 避免使用可修改的全局变量，因为它们使使用它们的所有部分相互依赖。

- 每个变量的作用域应该尽可能小。例如，一个局部对象可以在第一次使用它之前声明。

- 尽可能使相关对象是不可变的。

- 通过使用水平和垂直的间距使代码可读性更高。例如，将相关的结构对齐，并使用空行将两个部分分隔开。

- 通过为对象、类型、函数等选择描述性（但相对较短）的名称，使代码自我说明。

- 如果需要嵌套的部分，将其作为一个函数。

- 使你的函数短小，专注于一个单一的任务。旧的24行限制仍然适用。尽管屏幕尺寸和分辨率发生了变化，但人类的认知自20世纪60年代以来没有发生变化。

- 函数应该具有较少的参数（四个是一个好的上限）。这并不限制向函数传递的数据：将相关参数分组为一个对象有益于*对象不变量*，并节省了推理的过程，例如它们的一致性和一致性。

- 更一般地说，每个代码单元，从一个代码块到一个库，应该有一个*窄接口*。较少的通信减少了所需的推理。这意味着*获取器*返回内部状态是一种负担——不要向对象询问信息以进行操作。相反，要求对象使用它已经拥有的信息进行工作。换句话说，*封装*只关乎*窄接口*。

- 为了保持类的*不变量*，应该避免使用*设置器*，因为*设置器*往往会允许违反控制对象状态的不变量。

除了推理代码的正确性之外，对代码进行论证还可以增进对其的理解。将你获得的见解传达给其他人，以使每个人受益。

由[Yechiel Kimchi](http://programmer.97things.oreilly.com/wiki/index.php/Yechiel_Kimchi)撰写
